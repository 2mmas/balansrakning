<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balansr√§kning</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }

        .header h1 {
            color: #333;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
        }

        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }

        .month-nav {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #333;
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .month-nav:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .current-month {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            min-width: 180px;
        }

        .balance-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }

        .add-expense-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-expense-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .add-expense-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .exchange-rate {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .exchange-rate-manual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .rate-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #333;
            text-align: center;
            font-size: 14px;
        }

        .rate-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .update-rate-btn {
            background: #007bff;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .update-rate-btn:hover {
            background: #0056b3;
        }

        .expense-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .person-section {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #e9ecef;
        }

        .person-section.moa {
            border-color: #8e44ad;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }

        .person-section.thomas {
            border-color: #2196f3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .person-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .expense-list {
            min-height: 200px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .expense-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .expense-item.private {
            background: linear-gradient(45deg, #fff3e0, #ffe0b2);
            border-left: 3px solid #ff9800;
        }

        .expense-info {
            flex: 1;
        }

        .expense-name {
            font-weight: bold;
            color: #333;
        }

        .expense-amount {
            color: #666;
            font-size: 14px;
        }

        .private-indicator {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            margin-right: 10px;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .summary-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            color: #333;
        }

        .summary-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #333;
        }

        .summary-layout {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: start;
        }

        .person-totals {
            background: white;
            padding: 24px;
            border-radius: 16px;
            border: 2px solid #e9ecef;
        }

        .person-totals.moa {
            border-color: #8e44ad;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }

        .person-totals.thomas {
            border-color: #2196f3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .person-totals h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
        }

        .totals-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .totals-line.shared {
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .totals-line.total {
            font-weight: bold;
            font-size: 16px;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
            padding: 12px 0 8px 0;
            margin-top: 12px;
            margin-bottom: 4px;
        }

        .balance-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .balance-arrow {
            font-size: 48px;
            color: #666;
            margin-bottom: 15px;
        }

        .balance-result {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            padding: 24px;
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            color: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(255, 71, 87, 0.3);
            min-width: 200px;
            line-height: 1.4;
        }

        .balance-result .main-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .balance-result .amount-sek {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .balance-result .amount-eur {
            font-size: 18px;
            font-weight: 600;
            opacity: 0.95;
        }

        .balance-result.negative {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            box-shadow: 0 4px 20px rgba(255, 71, 87, 0.3);
        }

        .balance-result.zero {
            background: linear-gradient(135deg, #2ed573 0%, #1dd1a1 100%);
            box-shadow: 0 4px 20px rgba(46, 213, 115, 0.3);
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
        }

        .sync-status.syncing {
            background: #ffc107;
            color: #333;
        }

        .sync-status.synced {
            background: #28a745;
            color: white;
        }

        .sync-status.error {
            background: #dc3545;
            color: white;
        }

        @media (max-width: 768px) {
            .expense-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .summary-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .balance-column {
                order: 3;
            }
            
            .person-totals.moa {
                order: 1;
            }
            
            .person-totals.thomas {
                order: 2;
            }
            
            .balance-arrow {
                transform: rotate(90deg);
                font-size: 36px;
            }
            
            .container {
                padding: 15px;
            }
            
            .month-selector {
                flex-direction: column;
                gap: 10px;
            }

            .exchange-rate-manual {
                flex-direction: column;
                gap: 5px;
            }

            .sync-status {
                top: 10px;
                right: 10px;
                font-size: 10px;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus" style="display: none;">Synkroniserar...</div>
    
    <div class="container">
        <div class="header">
            <h1>üí∞ Balansr√§kning</h1>
            <p>Gemensamma utgifter mellan Moa & Thomas</p>
        </div>

        <div class="month-selector">
            <button class="month-nav" onclick="changeMonth(-1)">‚Üê</button>
            <div class="current-month" id="currentMonth">Januari 2025</div>
            <button class="month-nav" onclick="changeMonth(1)">‚Üí</button>
        </div>

        <div class="balance-section">
            <button class="add-expense-btn" onclick="toggleForm()">
                ‚ûï L√§gg till utgiftspost
            </button>

            <div class="add-expense-form" id="addExpenseForm" style="display: none;">
                <h3>L√§gg till ny utgift</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label>Vad har du k√∂pt?</label>
                        <input type="text" id="expenseName" placeholder="T.ex. Hyra, Mat" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label>Summa</label>
                        <input type="number" id="expenseAmount" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label>Valuta</label>
                        <select id="expenseCurrency" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="SEK">SEK</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div>
                        <label>Vem betalade?</label>
                        <select id="expensePerson" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">V√§lj person</option>
                            <option value="moa">Moa</option>
                            <option value="thomas">Thomas</option>
                        </select>
                    </div>
                    <div>
                        <label>Typ av utgift</label>
                        <select id="expenseType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">V√§lj typ</option>
                            <option value="shared">Gemensamt</option>
                            <option value="private">Privat</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="hideForm()" style="padding: 10px 20px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer;">Avbryt</button>
                    <button type="button" onclick="addExpense()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">L√§gg till</button>
                </div>
            </div>

            <div class="exchange-rate" id="exchangeRate">
                V√§xelkurs: 1 EUR = <span id="currentRate">11.50</span> SEK
            </div>
            <div class="exchange-rate-manual">
                <span style="color: #666; font-size: 12px;">Uppdatera kurs:</span>
                <input type="number" class="rate-input" id="manualRate" placeholder="11.50" step="0.01">
                <button class="update-rate-btn" onclick="updateRate()">Uppdatera</button>
            </div>

            <div class="expense-grid">
                <div class="person-section moa">
                    <div class="person-title">üë©‚Äçü¶∞ Moa</div>
                    <div class="expense-list" id="moaExpenses"></div>
                </div>

                <div class="person-section thomas">
                    <div class="person-title">üë®‚Äçüíº Thomas</div>
                    <div class="expense-list" id="thomasExpenses"></div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-title">M√•nadens Balans</div>
            
            <div class="summary-layout">
                <div class="person-totals moa">
                    <h3>üë©‚Äçü¶∞ Moa</h3>
                    <div class="totals-line shared">
                        <span><strong>Total i Euro:</strong></span>
                        <span><strong id="moaTotalEUR">0 EUR</strong></span>
                    </div>
                    <div class="totals-line shared">
                        <span><strong>Total i SEK:</strong></span>
                        <span><strong id="moaTotalSEKShared">0 SEK</strong></span>
                    </div>
                    <div class="totals-line total">
                        <span><strong>Total summa:</strong></span>
                        <span><strong id="moaTotalSEK">0 SEK</strong></span>
                    </div>
                    <div class="totals-line total">
                        <span><strong></strong></span>
                        <span><strong id="moaTotalEURTotal">0 EUR</strong></span>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4 style="margin-bottom: 10px; font-size: 14px; color: #666;">Privata utgifter:</h4>
                        <div class="totals-line">
                            <span>Euro:</span>
                            <span id="moaPrivateEUR">0</span>
                        </div>
                        <div class="totals-line">
                            <span>SEK:</span>
                            <span id="moaPrivateSEK">0</span>
                        </div>
                    </div>
                </div>

                <div class="balance-column">
                    <div class="balance-arrow">‚ü∑</div>
                    <div class="balance-result" id="balanceResult">
                        <div class="main-text">M√•nadens Balans: 0 SEK</div>
                    </div>
                </div>

                <div class="person-totals thomas">
                    <h3>üë®‚Äçüíº Thomas</h3>
                    <div class="totals-line shared">
                        <span><strong>Total i Euro:</strong></span>
                        <span><strong id="thomasTotalEUR">0 EUR</strong></span>
                    </div>
                    <div class="totals-line shared">
                        <span><strong>Total i SEK:</strong></span>
                        <span><strong id="thomasTotalSEKShared">0 SEK</strong></span>
                    </div>
                    <div class="totals-line total">
                        <span><strong>Total summa:</strong></span>
                        <span><strong id="thomasTotalSEK">0 SEK</strong></span>
                    </div>
                    <div class="totals-line total">
                        <span><strong></strong></span>
                        <span><strong id="thomasTotalEURTotal">0 EUR</strong></span>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4 style="margin-bottom: 10px; font-size: 14px; color: #666;">Privata utgifter:</h4>
                        <div class="totals-line">
                            <span>Euro:</span>
                            <span id="thomasPrivateEUR">0</span>
                        </div>
                        <div class="totals-line">
                            <span>SEK:</span>
                            <span id="thomasPrivateSEK">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDVS63u7KNOPweEwUgIFBRv8iREIA6p068",
            authDomain: "balansrakning-35d46.firebaseapp.com",
            projectId: "balansrakning-35d46",
            storageBucket: "balansrakning-35d46.firebasestorage.app",
            messagingSenderId: "517144001949",
            appId: "1:517144001949:web:c914d88eadc770403c4374"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Make Firebase available globally
        window.firebaseDb = db;

        console.log('Firebase initialized successfully');
        
        // Initialize the app after Firebase is loaded
        window.initializeApp();
    </script>

    <script>
        // Global variables - unchanged
        let expenses = {};
        let currentDate = new Date();
        let exchangeRate = 11.50;
        let isOnline = true;
        let syncStatus = document.getElementById('syncStatus');
        
        const months = [
            'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni',
            'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'
        ];

        // Firebase functions - NEW
        async function syncToFirebase() {
            if (!window.firebaseDb || !isOnline) return;
            
            try {
                showSyncStatus('syncing');
                
                // Save expenses data
                const expensesRef = window.firebaseDoc(window.firebaseDb, 'balanceData', 'expenses');
                await window.firebaseSetDoc(expensesRef, { data: expenses }, { merge: true });
                
                // Save exchange rate
                const rateRef = window.firebaseDoc(window.firebaseDb, 'balanceData', 'settings');
                await window.firebaseSetDoc(rateRef, { exchangeRate: exchangeRate }, { merge: true });
                
                showSyncStatus('synced');
                
            } catch (error) {
                console.error('Firebase sync error:', error);
                showSyncStatus('error');
            }
        }

        async function loadFromFirebase() {
            if (!window.firebaseDb) return;
            
            try {
                // Load expenses
                const expensesRef = window.firebaseDoc(window.firebaseDb, 'balanceData', 'expenses');
                const expensesDoc = await window.firebaseGetDoc(expensesRef);
                if (expensesDoc.exists()) {
                    const firebaseData = expensesDoc.data().data;
                    if (firebaseData) {
                        expenses = firebaseData;
                    }
                }
                
                // Load exchange rate
                const settingsRef = window.firebaseDoc(window.firebaseDb, 'balanceData', 'settings');
                const settingsDoc = await window.firebaseGetDoc(settingsRef);
                if (settingsDoc.exists()) {
                    const rate = settingsDoc.data().exchangeRate;
                    if (rate) {
                        exchangeRate = rate;
                    }
                }
                
            } catch (error) {
                console.error('Firebase load error:', error);
                // Fall back to localStorage if Firebase fails
                loadFromLocalStorage();
            }
        }

        function showSyncStatus(status) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.style.display = 'block';
            statusEl.className = `sync-status ${status}`;
            
            switch(status) {
                case 'syncing':
                    statusEl.textContent = '‚è≥ Synkroniserar...';
                    break;
                case 'synced':
                    statusEl.textContent = '‚úÖ Synkroniserat';
                    setTimeout(() => statusEl.style.display = 'none', 2000);
                    break;
                case 'error':
                    statusEl.textContent = '‚ùå Synk-fel';
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                    break;
            }
        }

        // Fallback localStorage functions - UNCHANGED
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('balanceCalculatorData');
                if (savedData) {
                    expenses = JSON.parse(savedData);
                }
                
                const savedRate = localStorage.getItem('exchangeRate');
                if (savedRate) {
                    exchangeRate = parseFloat(savedRate);
                }
            } catch (error) {
                expenses = {};
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('balanceCalculatorData', JSON.stringify(expenses));
                localStorage.setItem('exchangeRate', exchangeRate.toString());
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // Modified data functions
        async function loadData() {
            // First load from localStorage (instant)
            loadFromLocalStorage();
            
            // Then try to load from Firebase (may take time)
            if (window.firebaseDb) {
                await loadFromFirebase();
            }
            
            const monthKey = getCurrentMonthKey();
            if (!expenses[monthKey]) {
                expenses[monthKey] = [];
            }
        }

        async function saveData() {
            // Always save to localStorage first (instant)
            saveToLocalStorage();
            
            // Then sync to Firebase (may take time)
            if (window.firebaseDb && isOnline) {
                await syncToFirebase();
            }
        }

        // Initialize function - MODIFIED
        window.initializeApp = async function() {
            await loadData();
            updateDisplay();
            updateExchangeRateDisplay();
        };

        // All other functions remain UNCHANGED
        function getCurrentMonthKey() {
            return `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
        }

        function updateDisplay() {
            updateMonthDisplay();
            updateExpenseLists();
            updateSummary();
            updateExchangeRateDisplay();
        }

        function updateExchangeRateDisplay() {
            document.getElementById('currentRate').textContent = exchangeRate.toFixed(2);
            document.getElementById('manualRate').placeholder = exchangeRate.toFixed(2);
        }

        function updateMonthDisplay() {
            const monthName = months[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${monthName} ${year}`;
        }

        async function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            await loadData();
            updateDisplay();
        }

        function toggleForm() {
            const form = document.getElementById('addExpenseForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function hideForm() {
            document.getElementById('addExpenseForm').style.display = 'none';
            clearForm();
        }

        function clearForm() {
            document.getElementById('expenseName').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCurrency').value = 'SEK';
            document.getElementById('expensePerson').value = '';
            document.getElementById('expenseType').value = '';
        }

        async function updateRate() {
            const newRate = parseFloat(document.getElementById('manualRate').value);
            if (newRate && newRate > 0) {
                exchangeRate = newRate;
                await saveData();
                updateDisplay();
                document.getElementById('manualRate').value = '';
            } else {
                alert('V√§nligen ange en giltig v√§xelkurs!');
            }
        }

        async function addExpense() {
            const name = document.getElementById('expenseName').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const currency = document.getElementById('expenseCurrency').value;
            const person = document.getElementById('expensePerson').value;
            const type = document.getElementById('expenseType').value;

            if (!name || !amount || !currency || !person || !type) {
                alert('V√§nligen fyll i alla f√§lt!');
                return;
            }

            if (amount <= 0) {
                alert('Beloppet m√•ste vara st√∂rre √§n 0!');
                return;
            }

            const expense = {
                id: Date.now(),
                name: name,
                amount: amount,
                currency: currency,
                person: person,
                type: type,
                date: new Date().toISOString()
            };

            const monthKey = getCurrentMonthKey();
            if (!expenses[monthKey]) {
                expenses[monthKey] = [];
            }
            
            expenses[monthKey].push(expense);
            await saveData();
            updateDisplay();
            hideForm();
        }

        async function deleteExpense(expenseId) {
            const monthKey = getCurrentMonthKey();
            if (expenses[monthKey]) {
                expenses[monthKey] = expenses[monthKey].filter(exp => exp.id !== expenseId);
                await saveData();
                updateDisplay();
            }
        }

        function convertToSEK(amount, currency) {
            return currency === 'EUR' ? amount * exchangeRate : amount;
        }

        function updateExpenseLists() {
            const monthKey = getCurrentMonthKey();
            const monthExpenses = expenses[monthKey] || [];
            
            const moaContainer = document.getElementById('moaExpenses');
            const thomasContainer = document.getElementById('thomasExpenses');
            
            moaContainer.innerHTML = '';
            thomasContainer.innerHTML = '';

            monthExpenses.forEach(expense => {
                const expenseElement = createExpenseElement(expense);
                
                if (expense.person === 'moa') {
                    moaContainer.appendChild(expenseElement);
                } else if (expense.person === 'thomas') {
                    thomasContainer.appendChild(expenseElement);
                }
            });
        }

        function createExpenseElement(expense) {
            const div = document.createElement('div');
            div.className = `expense-item ${expense.type === 'private' ? 'private' : ''}`;
            
            div.innerHTML = `
                <div class="expense-info">
                    <div class="expense-name">${expense.name}</div>
                    <div class="expense-amount">${expense.amount.toFixed(2)} ${expense.currency}</div>
                </div>
                ${expense.type === 'private' ? '<div class="private-indicator">üè† Privat</div>' : ''}
                <button class="delete-btn" onclick="deleteExpense(${expense.id})">√ó</button>
            `;
            
            return div;
        }

        function updateSummary() {
            const monthKey = getCurrentMonthKey();
            const monthExpenses = expenses[monthKey] || [];
            
            let moaSharedEUR = 0, moaSharedSEK = 0;
            let moaPrivateEUR = 0, moaPrivateSEK = 0;
            let thomasSharedEUR = 0, thomasSharedSEK = 0;
            let thomasPrivateEUR = 0, thomasPrivateSEK = 0;

            monthExpenses.forEach(expense => {
                const isEUR = expense.currency === 'EUR';
                const isMoa = expense.person === 'moa';
                const isShared = expense.type === 'shared';

                if (isMoa && isShared) {
                    if (isEUR) moaSharedEUR += expense.amount;
                    else moaSharedSEK += expense.amount;
                } else if (isMoa && !isShared) {
                    if (isEUR) moaPrivateEUR += expense.amount;
                    else moaPrivateSEK += expense.amount;
                } else if (!isMoa && isShared) {
                    if (isEUR) thomasSharedEUR += expense.amount;
                    else thomasSharedSEK += expense.amount;
                } else if (!isMoa && !isShared) {
                    if (isEUR) thomasPrivateEUR += expense.amount;
                    else thomasPrivateSEK += expense.amount;
                }
            });

            // Update private expenses
            document.getElementById('moaPrivateEUR').textContent = moaPrivateEUR.toFixed(2);
            document.getElementById('moaPrivateSEK').textContent = moaPrivateSEK.toFixed(2);
            document.getElementById('thomasPrivateEUR').textContent = thomasPrivateEUR.toFixed(2);
            document.getElementById('thomasPrivateSEK').textContent = thomasPrivateSEK.toFixed(2);

            // Calculate totals for shared expenses
            document.getElementById('moaTotalEUR').textContent = moaSharedEUR.toFixed(2) + ' EUR';
            document.getElementById('moaTotalSEKShared').textContent = moaSharedSEK.toFixed(2) + ' SEK';
            document.getElementById('thomasTotalEUR').textContent = thomasSharedEUR.toFixed(2) + ' EUR';
            document.getElementById('thomasTotalSEKShared').textContent = thomasSharedSEK.toFixed(2) + ' SEK';

            // Convert to SEK for grand total
            const moaGrandTotal = convertToSEK(moaSharedEUR, 'EUR') + moaSharedSEK;
            const thomasGrandTotal = convertToSEK(thomasSharedEUR, 'EUR') + thomasSharedSEK;
            
            // Update grand total in SEK and EUR
            document.getElementById('moaTotalSEK').textContent = moaGrandTotal.toFixed(2) + ' SEK';
            document.getElementById('thomasTotalSEK').textContent = thomasGrandTotal.toFixed(2) + ' SEK';

            const moaGrandTotalEUR = moaGrandTotal / exchangeRate;
            const thomasGrandTotalEUR = thomasGrandTotal / exchangeRate;
            document.getElementById('moaTotalEURTotal').textContent = moaGrandTotalEUR.toFixed(2) + ' EUR';
            document.getElementById('thomasTotalEURTotal').textContent = thomasGrandTotalEUR.toFixed(2) + ' EUR';

            // Calculate balance
            const balance = moaGrandTotal - thomasGrandTotal;
            const balanceElement = document.getElementById('balanceResult');
            
            balanceElement.className = 'balance-result';
            
            if (balance > 0) {
                const balanceEUR = (Math.abs(balance) / exchangeRate).toFixed(2);
                balanceElement.innerHTML = `
                    <div class="main-text">Thomas √§r skyldig Moa</div>
                    <div class="amount-sek">${Math.abs(balance).toFixed(2)} SEK</div>
                    <div class="amount-eur">${balanceEUR} EUR</div>
                `;
                balanceElement.classList.add('negative');
            } else if (balance < 0) {
                const balanceEUR = (Math.abs(balance) / exchangeRate).toFixed(2);
                balanceElement.innerHTML = `
                    <div class="main-text">Moa √§r skyldig Thomas</div>
                    <div class="amount-sek">${Math.abs(balance).toFixed(2)} SEK</div>
                    <div class="amount-eur">${balanceEUR} EUR</div>
                `;
                balanceElement.classList.add('negative');
            } else {
                balanceElement.innerHTML = '<div class="main-text">Ni √§r kvitt! üéâ</div>';
                balanceElement.classList.add('zero');
            }
        }

        // Network status detection
        window.addEventListener('online', () => {
            isOnline = true;
            if (window.firebaseDb) {
                syncToFirebase();
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            showSyncStatus('error');
        });

        // Real-time sync listener (optional - aktiveras n√§r Firebase √§r redo)
        function setupRealtimeSync() {
            if (!window.firebaseDb) return;
            
            // Listen to expenses changes
            const expensesRef = window.firebaseDoc(window.firebaseDb, 'balanceData', 'expenses');
            window.firebaseOnSnapshot(expensesRef, (doc) => {
                if (doc.exists()) {
                    const firebaseData = doc.data().data;
                    if (firebaseData && JSON.stringify(firebaseData) !== JSON.stringify(expenses)) {
                        expenses = firebaseData;
                        updateDisplay();
                        showSyncStatus('synced');
                    }
                }
            });
            
            // Listen to settings changes
            const settingsRef = window.firebaseDoc(window.firebaseDb, 'balanceData', 'settings');
            window.firebaseOnSnapshot(settingsRef, (doc) => {
                if (doc.exists()) {
                    const rate = doc.data().exchangeRate;
                    if (rate && rate !== exchangeRate) {
                        exchangeRate = rate;
                        updateDisplay();
                        showSyncStatus('synced');
                    }
                }
            });
        }

        // Setup real-time sync after 2 seconds (to let Firebase initialize)
        setTimeout(() => {
            if (window.firebaseDb) {
                setupRealtimeSync();
            }
        }, 2000);
    </script>
</body>
</html>
