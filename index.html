<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Balansr√§kning</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; background: white; padding: 30px 20px; border-radius: 20px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); }
        .header h1 { color: #333; margin-bottom: 8px; }
        .header p { color: #666; }
        .month-selector { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); }
        .month-nav { background: #f8f9fa; border: 2px solid #e9ecef; color: #333; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-size: 18px; transition: all .3s ease; }
        .month-nav:hover { background: #e9ecef; border-color: #dee2e6; }
        .current-month { font-size: 24px; font-weight: 600; color: #333; min-width: 180px; }
        .balance-section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); }
        .add-expense-btn { background: linear-gradient(45deg,#4CAF50,#45a049); color: white; border: none; padding: 15px 25px; border-radius: 25px; font-size: 16px; cursor: pointer; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(76,175,80,.3); transition: all .3s ease; width: 100%; }
        .add-expense-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76,175,80,.4); }
        .add-expense-form { background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .exchange-rate { text-align: center; color: #666; font-size: 14px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid #e9ecef; }
        .exchange-rate-manual { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .rate-input { width: 80px; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; background: white; color: #333; text-align: center; font-size: 14px; }
        .rate-input:focus { outline: none; border-color: #007bff; }
        .update-rate-btn { background: #007bff; border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all .2s ease; }
        .update-rate-btn:hover { background: #0056b3; }
        .expense-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .person-section { background: #f8f9fa; border-radius: 16px; padding: 24px; border: 2px solid #e9ecef; }
        .person-section.moa { border-color: #8e44ad; background: linear-gradient(135deg,#f3e5f5 0%,#e1bee7 100%); }
        .person-section.thomas { border-color: #2196f3; background: linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%); }
        .person-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .expense-list { min-height: 200px; }
        .expense-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 12px; background: white; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,.1); transition: all .3s ease; }
        .expense-item:hover { transform: translateX(5px); box-shadow: 0 4px 10px rgba(0,0,0,.15); }
        .expense-item.private { background: linear-gradient(45deg,#fff3e0,#ffe0b2); border-left: 3px solid #ff9800; }
        .expense-badges { display:flex; gap:6px; align-items:center; }
        .badge { background:#efefef; border:1px solid #ddd; padding:2px 8px; border-radius:999px; font-size:12px; white-space:nowrap; }
        .badge.shared { background:#e8f5e9; border-color:#c8e6c9; }
        .badge.private { background:#ffecb3; border-color:#ffe082; }
        .expense-info { flex: 1; min-width:0; }
        .expense-name { font-weight: bold; color: #333; }
        .expense-amount { color: #666; font-size: 14px; }
        .expense-date { color:#777; font-size:12px; }
        .private-indicator { background: #ff9800; color: white; padding: 4px 8px; border-radius: 15px; font-size: 12px; margin-right: 10px; }
        .delete-btn { background: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 12px; transition: all .3s ease; }
        .delete-btn:hover { background: #d32f2f; transform: scale(1.1); }
        .summary-section { background: white; border-radius: 20px; padding: 30px; margin-top: 30px; box-shadow: 0 2px 20px rgba(0,0,0,.08); color: #333; }
        .summary-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 25px; color: #333; }
        .summary-layout { display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: start; }
        .person-totals { background: white; padding: 24px; border-radius: 16px; border: 2px solid #e9ecef; }
        .person-totals.moa { border-color: #8e44ad; background: linear-gradient(135deg,#f3e5f5 0%,#e1bee7 100%); }
        .person-totals.thomas { border-color: #2196f3; background: linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%); }
        .person-totals h3 { margin-bottom: 15px; font-size: 18px; color: #333; }
        .totals-line { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 5px 0; }
        .totals-line.shared { font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 12px; }
        .totals-line.total { font-weight: bold; font-size: 16px; border-top: 2px solid #333; border-bottom: 2px solid #333; padding: 12px 0 8px 0; margin-top: 12px; margin-bottom: 4px; }
        .balance-column { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .balance-arrow { font-size: 48px; color: #666; margin-bottom: 15px; }
        .balance-result { text-align: center; font-size: 18px; font-weight: 600; padding: 24px; background: linear-gradient(135deg,#ff4757 0%,#ff3838 100%); color: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(255,71,87,.3); min-width: 200px; line-height: 1.4; }
        .balance-result .main-text { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .balance-result .amount-sek { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
        .balance-result .amount-eur { font-size: 18px; font-weight: 600; opacity: .95; }
        .balance-result.negative { background: linear-gradient(135deg,#ff4757 0%,#ff3838 100%); box-shadow: 0 4px 20px rgba(255,71,87,.3); }
        .balance-result.zero { background: linear-gradient(135deg,#2ed573 0%,#1dd1a1 100%); box-shadow: 0 4px 20px rgba(46,213,115,.3); }
        .sync-status { position: fixed; top: 20px; right: 20px; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; z-index: 1000; display: none; }
        .sync-status.syncing { background: #ffc107; color: #333; display: block; }
        .sync-status.synced { background: #28a745; color: white; display: block; }
        .sync-status.error { background: #dc3545; color: white; display: block; }
        @media (max-width: 768px) {
            .expense-grid { grid-template-columns: 1fr; gap: 20px; }
            .summary-layout { grid-template-columns: 1fr; gap: 20px; }
            .balance-column { order: 3; }
            .person-totals.moa { order: 1; }
            .person-totals.thomas { order: 2; }
            .balance-arrow { transform: rotate(90deg); font-size: 36px; }
            .container { padding: 15px; }
            .month-selector { flex-direction: column; gap: 10px; }
            .exchange-rate-manual { flex-direction: column; gap: 5px; }
            .sync-status { top: 10px; right: 10px; font-size: 10px; padding: 6px 8px; }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus">Synkroniserar...</div>

    <div class="container">
        <div class="header">
            <h1>üí∞ Balansr√§kning</h1>
            <p>Gemensamma utgifter mellan Moa & Thomas</p>
        </div>

        <div class="month-selector">
            <button class="month-nav" onclick="changeMonth(-1)">‚Üê</button>
            <div class="current-month" id="currentMonth">Januari 2025</div>
            <button class="month-nav" onclick="changeMonth(1)">‚Üí</button>
        </div>

        <div class="balance-section">
            <button class="add-expense-btn" onclick="toggleForm()">‚ûï L√§gg till utgiftspost</button>

            <div class="add-expense-form" id="addExpenseForm" style="display:none;">
                <h3>L√§gg till ny utgift</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label>Vad har du k√∂pt?</label>
                        <input type="text" id="expenseName" placeholder="T.ex. Hyra, Mat" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;" />
                    </div>
                    <div>
                        <label>Summa</label>
                        <input type="number" id="expenseAmount" step="0.01" placeholder="0.00" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;" />
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label>Valuta</label>
                        <select id="expenseCurrency" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
                            <option value="SEK">SEK</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div>
                        <label>Vem betalade?</label>
                        <select id="expensePerson" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
                            <option value="">V√§lj person</option>
                            <option value="moa">Moa</option>
                            <option value="thomas">Thomas</option>
                        </select>
                    </div>
                    <div>
                        <label>Typ av utgift</label>
                        <select id="expenseType" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
                            <option value="">V√§lj typ</option>
                            <option value="shared">Gemensamt</option>
                            <option value="private">Privat</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label>Datum</label>
                        <input type="date" id="expenseDate" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;" />
                    </div>
                    <div style="display:flex; align-items:end; gap:10px;">
                        <span class="badge shared">ü§ù Gemensamt delas 50/50</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" onclick="hideForm()" style="padding:10px 20px; background:#e0e0e0; border:none; border-radius:5px; cursor:pointer;">Avbryt</button>
                    <button type="button" onclick="addExpense()" style="padding:10px 20px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer;">L√§gg till</button>
                </div>
            </div>

            <div class="exchange-rate" id="exchangeRate">V√§xelkurs: 1 EUR = <span id="currentRate">11.50</span> SEK</div>
            <div class="exchange-rate-manual">
                <span style="color:#666; font-size:12px;">Uppdatera kurs:</span>
                <input type="number" class="rate-input" id="manualRate" placeholder="11.50" step="0.01" />
                <button class="update-rate-btn" onclick="updateRate()">Uppdatera</button>
            </div>

            <div class="expense-grid">
                <div class="person-section moa">
                    <div class="person-title">üë©‚Äçü¶∞ Moa</div>
                    <div class="expense-list" id="moaExpenses"></div>
                </div>
                <div class="person-section thomas">
                    <div class="person-title">üë®‚Äçüíº Thomas</div>
                    <div class="expense-list" id="thomasExpenses"></div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-title">M√•nadens Balans</div>
            <div class="summary-layout">
                <div class="person-totals moa">
                    <h3>üë©‚Äçü¶∞ Moa</h3>
                    <div class="totals-line shared"><span><strong>Delade utgifter i EUR:</strong></span><span><strong id="moaTotalEUR">0 EUR</strong></span></div>
                    <div class="totals-line shared"><span><strong>Delade utgifter i SEK:</strong></span><span><strong id="moaTotalSEKShared">0 SEK</strong></span></div>
                    <div class="totals-line total"><span><strong>Delat (SEK, omr√§knat):</strong></span><span><strong id="moaTotalSEK">0 SEK</strong></span></div>
                    <div class="totals-line total"><span><strong>Delat (EUR):</strong></span><span><strong id="moaTotalEURTotal">0 EUR</strong></span></div>
                    <div style="margin-top:20px; padding-top:15px; border-top:1px solid #ddd;">
                        <h4 style="margin-bottom:10px; font-size:14px; color:#666;">Privata utgifter:</h4>
                        <div class="totals-line"><span>Euro:</span><span id="moaPrivateEUR">0</span></div>
                        <div class="totals-line"><span>SEK:</span><span id="moaPrivateSEK">0</span></div>
                    </div>
                </div>

                <div class="balance-column">
                    <div class="balance-arrow">‚ü∑</div>
                    <div class="balance-result" id="balanceResult"><div class="main-text">M√•nadens Balans: 0 SEK</div></div>
                </div>

                <div class="person-totals thomas">
                    <h3>üë®‚Äçüíº Thomas</h3>
                    <div class="totals-line shared"><span><strong>Delade utgifter i EUR:</strong></span><span><strong id="thomasTotalEUR">0 EUR</strong></span></div>
                    <div class="totals-line shared"><span><strong>Delade utgifter i SEK:</strong></span><span><strong id="thomasTotalSEKShared">0 SEK</strong></span></div>
                    <div class="totals-line total"><span><strong>Delat (SEK, omr√§knat):</strong></span><span><strong id="thomasTotalSEK">0 SEK</strong></span></div>
                    <div class="totals-line total"><span><strong>Delat (EUR):</strong></span><span><strong id="thomasTotalEURTotal">0 EUR</strong></span></div>
                    <div style="margin-top:20px; padding-top:15px; border-top:1px solid #ddd;">
                        <h4 style="margin-bottom:10px; font-size:14px; color:#666;">Privata utgifter:</h4>
                        <div class="totals-line"><span>Euro:</span><span id="thomasPrivateEUR">0</span></div>
                        <div class="totals-line"><span>SEK:</span><span id="thomasPrivateSEK">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v8 (compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Global state
        let expenses = {};
        let currentDate = new Date();
        let exchangeRate = 11.50;
        let isOnline = navigator.onLine;
        let db = null;

        const months = ['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September','Oktober','November','December'];

        // ---- Firebase init ----
        function initFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyDVS63u7KNOPweEwUgIFBRv8iREIA6p068",
                    authDomain: "balansrakning-35d46.firebaseapp.com",
                    projectId: "balansrakning-35d46",
                    storageBucket: "balansrakning-35d46.appspot.com",
                    messagingSenderId: "517144001949",
                    appId: "1:517144001949:web:c914d88eadc770403c4374"
                };
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log('Firebase initialized ‚úÖ');
                return true;
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                db = null;
                return false;
            }
        }

        // ---- Firestore sync ----
        async function syncToFirebase() {
            if (!db || !isOnline) return;
            try {
                showSyncStatus('syncing');
                await db.collection('balanceData').doc('expenses').set({
                    data: expenses,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('balanceData').doc('settings').set({
                    exchangeRate: exchangeRate,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                showSyncStatus('synced');
            } catch (error) {
                console.error('Firebase sync error:', error);
                showSyncStatus('error');
            }
        }

        async function loadFromFirebase() {
            if (!db) return;
            try {
                const expensesDoc = await db.collection('balanceData').doc('expenses').get();
                if (expensesDoc.exists) {
                    const data = expensesDoc.data();
                    if (data && data.data) expenses = data.data;
                }
                const settingsDoc = await db.collection('balanceData').doc('settings').get();
                if (settingsDoc.exists) {
                    const data = settingsDoc.data();
                    if (data && typeof data.exchangeRate === 'number') exchangeRate = data.exchangeRate;
                }
            } catch (error) {
                console.error('Firebase load error:', error);
                loadFromLocalStorage();
            }
        }

        function showSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            el.className = `sync-status ${status}`;
            switch (status) {
                case 'syncing': el.textContent = '‚è≥ Synkroniserar...'; break;
                case 'synced': el.textContent = '‚úÖ Synkroniserat'; setTimeout(()=> el.style.display='none', 2000); break;
                case 'error': el.textContent = '‚ùå Synk-fel'; setTimeout(()=> el.style.display='none', 3000); break;
            }
        }

        // ---- localStorage fallback ----
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('balanceCalculatorData');
                if (savedData) expenses = JSON.parse(savedData);
                const savedRate = localStorage.getItem('exchangeRate');
                if (savedRate) exchangeRate = parseFloat(savedRate);
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                expenses = {};
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('balanceCalculatorData', JSON.stringify(expenses));
                localStorage.setItem('exchangeRate', exchangeRate.toString());
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // ---- Data management ----
        async function loadData() {
            loadFromLocalStorage();
            if (db) await loadFromFirebase();
            const monthKey = getCurrentMonthKey();
            if (!expenses[monthKey]) expenses[monthKey] = [];
        }

        async function saveData() {
            saveToLocalStorage();
            if (db && isOnline) await syncToFirebase();
        }

        // ---- App logic ----
        function getCurrentMonthKey() {
            const y = currentDate.getFullYear();
            const m = String(currentDate.getMonth() + 1).padStart(2, '0');
            return `${y}-${m}`; // zero-padded
        }

        function updateDisplay() {
            updateMonthDisplay();
            updateExpenseLists();
            updateSummary();
            updateExchangeRateDisplay();
        }

        function updateExchangeRateDisplay() {
            document.getElementById('currentRate').textContent = exchangeRate.toFixed(2);
            document.getElementById('manualRate').placeholder = exchangeRate.toFixed(2);
        }

        function updateMonthDisplay() {
            const monthName = months[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${monthName} ${year}`;
        }

        async function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            await loadData();
            updateDisplay();
        }

        function toggleForm() {
            const form = document.getElementById('addExpenseForm');
            // F√∂rifyll dagens datum i datumf√§ltet
            const dateInput = document.getElementById('expenseDate');
            if (dateInput && !dateInput.value) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth()+1).padStart(2,'0');
                const dd = String(today.getDate()).padStart(2,'0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        function hideForm() { document.getElementById('addExpenseForm').style.display = 'none'; clearForm(); }
        function clearForm() {
            document.getElementById('expenseName').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCurrency').value = 'SEK';
            document.getElementById('expensePerson').value = '';
            document.getElementById('expenseType').value = '';
            document.getElementById('expenseDate').value = '';
        }

        async function updateRate() {
            const newRate = parseFloat(document.getElementById('manualRate').value);
            if (newRate && newRate > 0) {
                exchangeRate = newRate;
                await saveData();
                updateDisplay();
                document.getElementById('manualRate').value = '';
            } else {
                alert('V√§nligen ange en giltig v√§xelkurs!');
            }
        }

        async function addExpense() {
            const name = document.getElementById('expenseName').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const currency = document.getElementById('expenseCurrency').value;
            const person = document.getElementById('expensePerson').value;
            const type = document.getElementById('expenseType').value;
            const dateStr = document.getElementById('expenseDate').value; // YYYY-MM-DD

            if (!name || !amount || !currency || !person || !type) { alert('V√§nligen fyll i alla f√§lt!'); return; }
            if (amount <= 0) { alert('Beloppet m√•ste vara st√∂rre √§n 0!'); return; }

            const dateISO = dateStr ? new Date(dateStr + 'T12:00:00').toISOString() : new Date().toISOString();

            const expense = { id: Date.now(), name, amount, currency, person, type, date: dateISO };
            const monthKey = getCurrentMonthKey();
            if (!expenses[monthKey]) expenses[monthKey] = [];
            expenses[monthKey].push(expense);
            await saveData();
            updateDisplay();
            hideForm();
        }

        async function deleteExpense(expenseId) {
            const monthKey = getCurrentMonthKey();
            if (expenses[monthKey]) {
                expenses[monthKey] = expenses[monthKey].filter(exp => exp.id !== expenseId);
                await saveData();
                updateDisplay();
            }
        }

        function convertToSEK(amount, currency) { return currency === 'EUR' ? amount * exchangeRate : amount; }

        function formatDate(dateISO) {
            try {
                const d = new Date(dateISO);
                const dd = String(d.getDate()).padStart(2,'0');
                const mm = String(d.getMonth()+1).padStart(2,'0');
                const yyyy = d.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            } catch { return ''; }
        }

        function updateExpenseLists() {
            const monthKey = getCurrentMonthKey();
            const monthExpenses = expenses[monthKey] || [];
            const moaContainer = document.getElementById('moaExpenses');
            const thomasContainer = document.getElementById('thomasExpenses');
            moaContainer.innerHTML = '';
            thomasContainer.innerHTML = '';
            monthExpenses.forEach(expense => {
                const el = createExpenseElement(expense);
                if (expense.person === 'moa') moaContainer.appendChild(el);
                else if (expense.person === 'thomas') thomasContainer.appendChild(el);
            });
        }

        function createExpenseElement(expense) {
            const div = document.createElement('div');
            div.className = `expense-item ${expense.type === 'private' ? 'private' : ''}`;
            const sharedBadge = expense.type === 'shared' ? '<span class="badge shared">ü§ù Gemensam</span>' : '';
            const privateBadge = expense.type === 'private' ? '<span class="badge private">üè† Privat</span>' : '';
            div.innerHTML = `
                <div class="expense-info">
                    <div class="expense-name">${expense.name}</div>
                    <div class="expense-amount">${expense.amount.toFixed(2)} ${expense.currency}</div>
                    <div class="expense-date">${formatDate(expense.date)}</div>
                </div>
                <div class="expense-badges">${sharedBadge}${privateBadge}</div>
                <button class="delete-btn" title="Ta bort" onclick="deleteExpense(${expense.id})">√ó</button>
            `;
            return div;
        }

        function updateSummary() {
            const monthKey = getCurrentMonthKey();
            const monthExpenses = expenses[monthKey] || [];

            let moaSharedEUR = 0, moaSharedSEK = 0, moaPrivateEUR = 0, moaPrivateSEK = 0;
            let thomasSharedEUR = 0, thomasSharedSEK = 0, thomasPrivateEUR = 0, thomasPrivateSEK = 0;

            monthExpenses.forEach(expense => {
                const isEUR = expense.currency === 'EUR';
                const isMoa = expense.person === 'moa';
                const isShared = expense.type === 'shared';
                if (isMoa && isShared) { if (isEUR) moaSharedEUR += expense.amount; else moaSharedSEK += expense.amount; }
                else if (isMoa && !isShared) { if (isEUR) moaPrivateEUR += expense.amount; else moaPrivateSEK += expense.amount; }
                else if (!isMoa && isShared) { if (isEUR) thomasSharedEUR += expense.amount; else thomasSharedSEK += expense.amount; }
                else if (!isMoa && !isShared) { if (isEUR) thomasPrivateEUR += expense.amount; else thomasPrivateSEK += expense.amount; }
            });

            // Visa privata totals
            document.getElementById('moaPrivateEUR').textContent = moaPrivateEUR.toFixed(2);
            document.getElementById('moaPrivateSEK').textContent = moaPrivateSEK.toFixed(2);
            document.getElementById('thomasPrivateEUR').textContent = thomasPrivateEUR.toFixed(2);
            document.getElementById('thomasPrivateSEK').textContent = thomasPrivateSEK.toFixed(2);

            // Visa delade totals per person (som input, ej halverat)
            document.getElementById('moaTotalEUR').textContent = moaSharedEUR.toFixed(2) + ' EUR';
            document.getElementById('moaTotalSEKShared').textContent = moaSharedSEK.toFixed(2) + ' SEK';
            document.getElementById('thomasTotalEUR').textContent = thomasSharedEUR.toFixed(2) + ' EUR';
            document.getElementById('thomasTotalSEKShared').textContent = thomasSharedSEK.toFixed(2) + ' SEK';

            // Omr√§kna respektives delade utgifter till SEK
            const moaSharedSEKTotal = convertToSEK(moaSharedEUR, 'EUR') + moaSharedSEK;
            const thomasSharedSEKTotal = convertToSEK(thomasSharedEUR, 'EUR') + thomasSharedSEK;

            // Visa deras (omr√§knade) delade totals i SEK/EUR
            document.getElementById('moaTotalSEK').textContent = moaSharedSEKTotal.toFixed(2) + ' SEK';
            document.getElementById('thomasTotalSEK').textContent = thomasSharedSEKTotal.toFixed(2) + ' SEK';
            document.getElementById('moaTotalEURTotal').textContent = (moaSharedSEKTotal / exchangeRate).toFixed(2) + ' EUR';
            document.getElementById('thomasTotalEURTotal').textContent = (thomasSharedSEKTotal / exchangeRate).toFixed(2) + ' EUR';

            // --- BALANSBER√ÑKNING 50/50 ---
            const totalSharedSEK = moaSharedSEKTotal + thomasSharedSEKTotal; // alla gemensamma utgifter
            const eachOwesSEK = totalSharedSEK / 2; // var och en ska st√• f√∂r h√§lften

            // Om Moa har betalat mer √§n h√§lften, √§r Thomas skyldig Moa mellanskillnaden ‚Äì och vice versa
            const moaDiff = moaSharedSEKTotal - eachOwesSEK; // positivt => Thomas √§r skyldig Moa
            const thomasDiff = thomasSharedSEKTotal - eachOwesSEK; // positivt => Moa √§r skyldig Thomas

            const balanceElement = document.getElementById('balanceResult');
            balanceElement.className = 'balance-result';

            if (Math.abs(moaDiff) < 0.005) {
                balanceElement.innerHTML = '<div class="main-text">Ni √§r kvitt! üéâ</div>';
                balanceElement.classList.add('zero');
            } else if (moaDiff > 0) {
                const sek = moaDiff;
                const eur = (sek / exchangeRate);
                balanceElement.innerHTML = `<div class="main-text">Thomas √§r skyldig Moa</div><div class="amount-sek">${sek.toFixed(2)} SEK</div><div class="amount-eur">${eur.toFixed(2)} EUR</div>`;
                balanceElement.classList.add('negative');
            } else {
                const sek = -moaDiff; // Moa m√•ste betala Thomas
                const eur = (sek / exchangeRate);
                balanceElement.innerHTML = `<div class="main-text">Moa √§r skyldig Thomas</div><div class="amount-sek">${sek.toFixed(2)} SEK</div><div class="amount-eur">${eur.toFixed(2)} EUR</div>`;
                balanceElement.classList.add('negative');
            }
        }

        // ---- Network status ----
        window.addEventListener('online', () => { isOnline = true; if (db) syncToFirebase(); });
        window.addEventListener('offline', () => { isOnline = false; showSyncStatus('error'); });

        // ---- App bootstrap ----
        window.addEventListener('load', async () => {
            const firebaseReady = initFirebase();
            await loadData();
            updateDisplay();
            if (firebaseReady && db) {
                try {
                    db.collection('balanceData').doc('expenses').onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            if (data && data.data && JSON.stringify(data.data) !== JSON.stringify(expenses)) {
                                expenses = data.data;
                                updateDisplay();
                                showSyncStatus('synced');
                            }
                        }
                    }, (error) => { console.log('Real-time sync disabled:', error.message); });
                    db.collection('balanceData').doc('settings').onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            if (data && typeof data.exchangeRate === 'number' && data.exchangeRate !== exchangeRate) {
                                exchangeRate = data.exchangeRate;
                                updateDisplay();
                                showSyncStatus('synced');
                            }
                        }
                    }, (error) => { console.log('Settings sync disabled:', error.message); });
                } catch (error) {
                    console.log('Real-time listeners could not be setup:', error);
                }
            }
        });
    </script>
</body>
</html>
